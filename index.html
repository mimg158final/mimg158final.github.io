<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Q&A Submission Portal</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getStorage, ref, uploadBytes } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBwASsafY-yc1g9m8o7786UXxKzzduUY1Y",
      authDomain: "mimg158final.firebaseapp.com",
      projectId: "mimg158final",
      storageBucket: "mimg158final.appspot.com",
      messagingSenderId: "896202597540",
      appId: "1:896202597540:web:72aacf0b2b4688fb56f231",
      measurementId: "G-0DDHJF3D7Y"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);

    function generatePassword() {
      return Math.random().toString(36).slice(-8);
    }

    window.handleSubmit = async function(event) {
      event.preventDefault();
      const form = event.target;
      const email = form.email.value.trim();
      if (!email) return alert("Email is required.");

      const fileInputs = form.querySelectorAll('input[type="file"]');
      const uploads = [];

      for (const input of fileInputs) {
        if (input.files.length === 0) return alert("Please upload all required files.");
        const file = input.files[0];
        const storageRef = ref(storage, `submissions/${email}/${input.name}-${file.name}`);
        uploads.push(uploadBytes(storageRef, file));
      }

      // Upload credentials file
      const password = generatePassword();
      const credentialsBlob = new Blob(
        [JSON.stringify({ email, password }, null, 2)],
        { type: 'application/json' }
      );
      const credentialsFile = new File([credentialsBlob], `credentials-${Date.now()}.json`);
      const credentialsRef = ref(storage, `credentials/${credentialsFile.name}`);
      uploads.push(uploadBytes(credentialsRef, credentialsFile));

      try {
        await Promise.all(uploads);
        alert("Submission complete. Your password is: " + password);
        window.location.href = "library.html";
      } catch (error) {
        console.error("Upload failed", error);
        alert("Error uploading files. Please try again.");
      }
    };
  </script>
  <style>
    body { font-family: Arial; max-width: 700px; margin: auto; padding: 20px; }
    h2 { border-bottom: 1px solid #ccc; padding-bottom: 5px; }
    label { display: block; margin-top: 20px; }
    input[type="file"], input[type="email"] { width: 100%; margin-top: 5px; }
    button { margin-top: 30px; padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>Submit All Required Files</h1>
  <form onsubmit="handleSubmit(event)">
    <label>Email (required):</label>
    <input type="email" name="email" required />
    <label>7/17 Lecture</label>
    <input type="file" name="lecture_717" required />
    <label>7/22 Welch, 2016 Paper</label>
    <input type="file" name="welch_722" required />
    <label>7/17 Keim, 2008 Paper</label>
    <input type="file" name="keim_2008" required />
    <label>7/17 Keim, 2000 Paper</label>
    <input type="file" name="keim_2000" required />
    <label>7/22 Lecture</label>
    <input type="file" name="lecture_722" required />
    <label>7/24 Wolfe, 2014 Paper</label>
    <input type="file" name="wolfe_724" required />
    <label>7/24 Lecture</label>
    <input type="file" name="lecture_724" required />
    <button type="submit">Submit & Get Password</button>
  </form>
</body>
</html>
